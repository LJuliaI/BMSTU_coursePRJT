$( document ).ready(function () {
floor (2);
$('.wrap1-btn0').click(function () {  //swithing between floors on button click
	hidebtn();
	cleardata ("floor");
	floor (0);
});
$('.wrap1-btn1').click(function () {
	hidebtn();
	cleardata ("floor");
	floor (1);
});
$('.wrap1-btn2').click(function () {
	hidebtn();
	cleardata ("floor");
	floor (2);
});
$('.wrap1-btn3').click(function () {
	hidebtn();
	cleardata ("floor");
	floor (3);
});
$('.wrap1-btn4').click(function () {
	hidebtn();
	cleardata ("floor");
	floor (4);
});
$('.wrap1-btn5').click(function () {
	hidebtn();
	cleardata ("floor");
	floor (5);
});
});
function mouseinf(){                                                  //adding pop-up of additional data on mouse hover
		$('.description').html($(this).attr('description-data'));
		$('.description').fadeIn(5);
}
function mouseoutf(){																								//removing data if mouse stops hovering
		$('.description').fadeOut(5);
}
function cleardata(elementID){																			//clears all elements with inserted id
	document.getElementById(elementID).innerHTML = "";
}
  function floor (etaz){																						//sends AJAX reqest for all rooms on a floor
	var param_str = "?" +"etaz=" + etaz
	var my_JSON_object = {};
	var link = location.protocol + "//" + location.host + "/map/getdata.json"
	var http_request = new XMLHttpRequest();
	http_request.open("GET", link+param_str, true);
	http_request.onreadystatechange = function () {
		var done = 4, ok = 200;
		if (http_request.readyState == done &&
			http_request.status == ok) {
				my_JSON_object = JSON.parse(http_request.responseText);
				show_result(my_JSON_object, etaz);
		}
	};
		http_request.send(null);
		return false;
	}
	function show_result(data, flor){																				//Adds all elements for rooms demonstration on document
		var newsvg = document.createElementNS("http://www.w3.org/2000/svg","svg"); //Enables svg graphics
		newsvg.setAttribute('class', "svg-btn2");
		newsvg.setAttribute('viewBox', "0 0 1382.6667 974.66669");
		data.forEach(function(rowData) {
			var newpth = document.createElementNS("http://www.w3.org/2000/svg","path");
			newpth.setAttribute('d', rowData["coord"]);
			newpth.setAttribute('description-data', rowData["name"]);
			newpth.setAttribute('fill', "#82befa");
			newpth.setAttribute('class', "part");
			newpth.addEventListener("mouseover", mouseinf);
			newpth.addEventListener("mouseout", mouseoutf);
			newsvg.appendChild(newpth);
		});
		document.getElementById("floor").appendChild(newsvg);
		var newimg = document.createElement("img");
		switch (flor) {																										//Adds floor blueprint
			case 0:
				newimg.setAttribute('src', "/images/bmstu0floor.jpg");
				break;
			case 1:
				newimg.setAttribute('src', "/images/bmstu1+floor.jpg");
				break;
			case 2:
				newimg.setAttribute('src', "/images/bmstu2floor.jpg");
				break;
			case 3:
				newimg.setAttribute('src', "/images/bmstu3floor.jpg");
				break;
			case 4:
					newimg.setAttribute('src', "/images/bmstu4floor.jpg");
					break;
			case 5:
						newimg.setAttribute('src', "/images/bmstu5floor.jpg");
						break;
			 }
		document.getElementById("floor").appendChild(newimg);
	}
	$('.wrap1-btn6').click(function() {																						//Searches for the room
	    const hiddenid = document.querySelector (".selected-input");
	    const searchid = hiddenid.value
			hidebtn();
	    $.ajax('/map/search.json', {																							//AJAX request for the room
	        method: 'POST',
	        data: {rid: searchid}
	    }).done(function (data) {
					cleardata ("floor")																										//clears current floor
					show_result (data["rooms"], data["floor"]) 														//shows the floor of the searched room
					var newpth = document.createElementNS("http://www.w3.org/2000/svg","path");  //shows searched room with different color
					newpth.setAttribute('d', data["room"]["coord"]);
					newpth.setAttribute('fill', "#e50e0e");
					newpth.setAttribute('class', "part2");
					newpth.setAttribute('description-data', data["room"]["name"]);
					newpth.addEventListener("mouseover", mouseinf);
					newpth.addEventListener("mouseout", mouseoutf);
					var parentNode = document.querySelector('.svg-btn2');
					parentNode.appendChild(newpth);
	    })

	    });
			$('.wrap1-btn7').click(function() {																				//buildin route between rooms
					const hiddenid = document.querySelectorAll (".selected-input");
					const startroom = hiddenid[1].value
					const finishroom = hiddenid[2].value
					hidebtn();
					$.ajax('/map/route.json', {																						//AJAX request for route building
							method: 'POST',
							data: {sid: startroom, fid: finishroom}
					}).done(function (data) {
						var btn = document.querySelector('.wrap1-btn8');										//enables button for following route
						btn.setAttribute('type', "submit");
						btn.setAttribute ('lastfloor', data["zones"][data["zones"].length - 1]["floor"])
						btn.setAttribute ('firstfloor', data["zones"][0]["floor"])
						floor_route(data)																										//shows part of the route on a one floor
					})

					});
			$('.wrap1-btn8').click(function() {																				//Continues route display on the next floor or end route display if this floor is last
						var btn = document.querySelector('.wrap1-btn8');
						if (btn.getAttribute('value') == "Завершить") {
							cleardata ("floor");
							etaz = Number(btn.getAttribute ("lastfloor"));
							floor(etaz);
							hidebtn();
						} else {
							zones = btn.getAttribute('data')
							jzones = JSON.parse (zones)
							floor_route(jzones);
						}
					});
		function floor_route(data){																									//selects zones for this floor
			cleardata ("floor")
			floor(data["zones"][0]["floor"])
			setTimeout(() => zone_show(data), 500);																		//shows selected zones
		}
		function zone_show(data){
			var currentfloor = data["zones"][0]["floor"]
			while (currentfloor == (data["zones"][0]["floor"])){											//Shows all selected zones
				var currentzone = data["zones"].shift();
				var newpth = document.createElementNS("http://www.w3.org/2000/svg","path");
				newpth.setAttribute('d', currentzone["coord"]);
				newpth.setAttribute('fill', "#17cf1d");
			  newpth.setAttribute('class', "part2");
				// newpth.setAttribute('description-data', data["room"]["name"]);
				var parentNode = document.querySelector('.svg-btn2');
				parentNode.appendChild(newpth);
				if (data["zones"] == "") {break}
			}
			var btn = document.querySelector('.wrap1-btn8');
			var firstfloor = Number(btn.getAttribute("firstfloor"))
			var lastfloor = Number(btn.getAttribute("lastfloor"))
			if (lastfloor == currentfloor) {																					//Displays the final room if it is the correct floor
				var newpth = document.createElementNS("http://www.w3.org/2000/svg","path");
				newpth.setAttribute('d', data["froom"]["coord"]);
				newpth.setAttribute('fill', "#e50e0e");
				newpth.setAttribute('class', "part2");
				newpth.setAttribute('description-data', data["froom"]["name"]);
				newpth.addEventListener("mouseover", mouseinf);
				newpth.addEventListener("mouseout", mouseoutf);
				var parentNode = document.querySelector('.svg-btn2');
				parentNode.appendChild(newpth);
			}
			if (firstfloor == currentfloor) {																						//Displays the first room if it is the first floor
				var newpth = document.createElementNS("http://www.w3.org/2000/svg","path");
				newpth.setAttribute('d', data["sroom"]["coord"]);
				newpth.setAttribute('fill', "#e50e0e");
				newpth.setAttribute('class', "part2");
				newpth.setAttribute('description-data', data["sroom"]["name"]);
				newpth.addEventListener("mouseover", mouseinf);
				newpth.addEventListener("mouseout", mouseoutf);
				var parentNode = document.querySelector('.svg-btn2');
				parentNode.appendChild(newpth);
			}
			if (data["zones"] == ""){																										//Sets button for route completion if there are no more zones in sent data
				btn.setAttribute('value', "Завершить");
			}
			btndata = JSON.stringify (data);
			btn.setAttribute('data', btndata);
		}
		function hidebtn() {																													//hides button after route completion
			var btn = document.querySelector('.wrap1-btn8');
			btn.setAttribute('type', "hidden");
			btn.setAttribute('value', "Далее");
			btn.setAttribute ('lastfloor', null);
			btn.setAttribute('data', null);
		}
